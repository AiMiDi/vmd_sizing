-------------------------------------------------
-------------------------------------------------

　「VMDサイジング　ローカル版」

　　ver3.00

　　　　　　　　　　　　　　　　　miu200521358

-------------------------------------------------
-------------------------------------------------


　この度は拙作をDLしていただき、ありがとうございます。
　お手数ですが以下をご確認のうえ、ご利用ください。

-------------------------------------------------

■ 概要　----------------------------------------

　VMD(MMDモーションデータ)を、指定されたモデルに適切な頭身で再生成するツールです。
　大きく以下の機能があります。

　【デフォルトで行われる機能】
　①　頭身に合わせて、センターや足IKなどの移動ボーンの距離を調整できます。
　②　腕の傾き具合をモーション作成元モデルと同じになるように調整できます。
　　　（Aスタンス⇔Tスタンスの相互変換も可能です）
　③　センターZを微調整して、重心の取り方をモーション作成元モデルと同じになるように調整できます。

　【任意で追加できる機能】
　④　モーションのモーフを変換先モデルの任意のモーフへと置き換えができます。
　⑤　ねんどろ風など頭身が大きく異なり、頭～上半身に手が貫通してしまう場合に、
　　　頭と手の接触回避を行うことができます。
　⑥　手を合わせるなどのモーションで、手首の位置合わせ処理を行うことができます。

　※対応しているのはモデルモーションのみです。カメラモーションは今のところ非対応です。
　※元々のモーションから動きが変わる事がありますので、自己責任でお願いします。


■ 配布動画　------------------------------------

　VMDサイジングに手首位置合わせを入れてみた【ver3.00】
　https://www.nicovideo.jp/watch/sm35191377


■ 同梱ファイル　------------------------------------

　・VMDSizing_3.00_xxbit.exe　　　…　ツール本体(32bit版 or 64bit版)
　・Readme.txt　　　　　　　　　　…　リドミ
　・モーフ置換サンプル　　　　　　…　モーフ置換のサンプル集（詳細は中参照）

■ 動作環境　------------------------------------

　Windows7/8/10 32/64bit


■ 確認済環境　------------------------------------

　・Windows10 64bit
　・Windows7　64bit


■ VMDサイジングの使い方　--------------------------------------

　①　exeを起動します

　②　「ファイル」タブのパラメーターを設定します

　　　いずれも、「開く」ボタンからダイアログが開き、ファイルを指定できます。D&Dでも指定可能です。
　　　「履歴」ボタンがある３ファイルは、これまでサイジングが実行されたパスを選択できます。
　　　履歴は、exeと同じフォルダに「history.json」として保存されます。

　　　　・調整対象VMDファイル（必須）
　　　　　　　…　調整したいVMDモーションデータファイル
　　　　　　　　　ファイルを指定すると、VMDファイルに登録されているモデル名を表示します。
　　　　　　　　　表示されたモデル名は選択したりコピペする事ができます。

　　　　・モーション作成元モデルPMXファイル（必須）
　　　　　　　…　モーションの作成時に用いられたモデルのPMXファイル（PMDは読み込めません）
　　　　　　　　　モーション作成元モデルが手元にない場合、大体同じ構造・サイズのモデルで代用可能です。
　　　　　　　　　代用の目安としては、膝をついたり、手を合わせたり、サイジングしたい箇所の修正が不要、
　　　　　　　　　あるいはできるだけ少ないモデルが適しています。

　　　　・モーション変換先モデルPMXファイル（必須）
　　　　　　　…　変換したいモデルのPMXファイル（PMDは読み込めません）

　　　　・出力VMDファイル（自動設定・変更可）
　　　　　　　…　変換結果VMDモーションデータファイルの出力先
　　　　　　　　　「調整対象VMDファイル」と「モーション変換先モデルPMXファイル」から自動生成しますが、任意のパスに変更可能です。
　　　　　　　　　オプションを変えるとファイル名に記号が付与されます。
　　　　　　　　　　・モーフ…M、接触回避…A、手首位置合わせ…P

　③　任意で「モーフ」タブのパラメーターを設定します
　　　※モーフの指定にモーション情報とモデル情報が必要なため、②の設定がすべて終わっていないと、「モーフ」タブは開けません。
　　　※モーフ置換組合せは、３つの項目すべてに値が入っている行のみ置換対象とします。
　　　　間違って行を追加してしまった場合、「モーションモーフ」か「置換後モーフ」のいずれかを空欄にしてください。
　　　　また、同じ「モーションモーフ」と「置換後モーフ」の組合せを指定した場合、
　　　　先に指定したモーフ置換組合せのみ置換対象となります。
　　　　そのため、何回もインポートしても、最初に指定された行のみが置換対象となります。

　　　　・モーションモーフ
　　　　　　　…　モーションで使用されているモーフ。
　　　　　　　　　【先頭の記号の意味】
　　　　　　　　　　〇：モーション・生成元モデル・変換先モデルすべてにあるモーフ
　　　　　　　　　　●：モーション・変換先モデルにあり、生成元モデルにないモーフ
　　　　　　　　　　▲：モーション・生成元モデルにあり、変換先モデルにないモーフ

　　　　・置換後モーフ
　　　　　　　…　代わりに使用したいモーフ

　　　　・大きさ補正
　　　　　　　…　モーフの大きさ

　　　　・行追加ボタン
　　　　　　　…　モーフ置換の指定行を増やすことができます。

　　　　・エクスポートボタン
　　　　　　　…　モーフ置換組合せデータをCSVファイルにエクスポートします。
　　　　　　　　　「調整対象VMDファイル」と同じフォルダに出力されます。

　　　　・インポートボタン
　　　　　　　…　モーフ置換組合せデータをCSVファイルからインポートします。


　④　任意で「腕」タブのパラメーターを設定します
　　　※腕の処理には、「接触回避」と「手首位置合わせ」の２パターンがありますが、いずれか１つしか選べません。
　　　　デフォルトは、いずれの処理も行わない、となっております。
　　　　いずれの処理もそれなりに時間がかかります。

　　　　A)　・頭～上半身と腕の接触回避を行う
　　　　　　　　…　頭～上半身と手指（人差し指３もしくは手首）の接触回避を行うかを選択できます。

　　　　　　・接触回避判定先
　　　　　　　　…　接触回避を行う場合に、人差し指と手首のどちらを判定対象とするか選べます。
　　　　　　　　　　デフォルトは人差し指ですが、腕の離れ具合が大きいと感じた時には、手首を選択してください。

　　　　B)　・手首位置合わせを行う
　　　　　　　　…　手を合わせるなど、手首の位置が一定範囲内の場合に、手首の位置をモーション作成元モデルと
　　　　　　　　　　同等の位置に合わせるように腕の各関節の角度を調整する処理を行います。

　　　　　　・手首間の距離
　　　　　　　　…　どの程度手首が近づいた場合に、手首位置合わせを行うか指定できます。
　　　　　　　　　　デフォルトでは、手を合わせる、ハートを作る、剣を握る、といった動作が手首位置合わせできます。
　　　　　　　　　　手首位置合わせをしてほしくないモーションまで処理されている場合、
　　　　　　　　　　メッセージ欄を確認して、そのキーフレームの手首間の距離より小さな値を設定してください。
　　　　　　　　　　逆に、もっと手首位置合わせをしてほしい場合には、同様に確認して、大きな値を入れてください。
　　　　　　　　　　スライダーを最大値に合わせると、常に手首位置合わせを行います。
　　　　　　　　　　出力した結果、メッセージ欄に「手首位置合わせ失敗」と出力されている場合、
　　　　　　　　　　手首位置合わせに失敗しているため、元モーションと同じ角度に戻っています。
　　　　　　　　　　ログファイルが出力VMDファイルと同じ場所に出来ていますので、確認してください。

　⑤　「変換前チェック」ボタンをクリックします（任意）
　　　変換処理前に、入力されたデータの整合性チェックを行います。
　　　例えば、変換先モデルに、モーションで使用されているボーン・モーフが足りない場合、警告メッセージが出力されます。
　　　この処理は任意ですが、モーションデータの正確なサイジングのために出来るだけ実行してください。
　　　警告だけなので、不要なボーン・モーフであれば無視しても構いません。

　⑥　「VMDサイジング実行」ボタンをクリックします
　　　変換前チェックを再度行い、ボーン・モーフが足りない場合、ログファイルに出力されます。

　⑦　「出力VMDファイル」にVMDモーションデータファイルが生成されます

　ウィンドウ下部には、ログメッセージが出力されます。
　詳しくは配布動画を参照してください。


■ VMDコンバーターの使い方　--------------------------------------

VMDファイルをファイル欄に入力して、出力ボタンをクリックしてください。
ボーンCSVとモーフCSVの２ファイルが出力されます。

補間曲線は、0-127の整数です。
ボーンCSVの補間曲線は、MMD側で読んでないデータも保持されている為、全部出力しています。
参考になるデータは下記を参照してください。

----------------------
【ボーンCSV：各項目の意味】

ボーン名：キーが登録されているボーン
フレーム：フレーム番号
位置X：ボーン位置X
位置Y：ボーン位置Y
位置Z：ボーン位置Z
回転X：ボーン回転X
回転Y：ボーン回転Y
回転Z：ボーン回転Z
【X_x1】：補間曲線 - X移動 - 開始X
Y_x1：（無視）
Z_x1：（無視）
R_x1：（無視）
【X_y1】：補間曲線 - X移動 - 開始Y
Y_y1：（無視）
Z_y1：（無視）
R_y1：（無視）
【X_x2】：補間曲線 - X移動 - 終了X
Y_x2：（無視）
Z_x2：（無視）
R_x2：（無視）
【X_y2】：補間曲線 - X移動 - 終了Y
Y_y2：（無視）
Z_y2：（無視）
R_y2：（無視）
【Y_x1】：補間曲線 - Y移動 - 開始X
Z_x1：（無視）
R_x1：（無視）
X_y1：（無視）
【Y_y1】：補間曲線 - Y移動 - 開始Y
Z_y1：（無視）
R_y1：（無視）
X_x2：（無視）
【Y_x2】：補間曲線 - Y移動 - 終了X
Z_x2：（無視）
R_x2：（無視）
X_y2：（無視）
【Y_y2】：補間曲線 - Y移動 - 終了Y
Z_y2：（無視）
R_y2：（無視）
1：（無視）
【Z_x1】：補間曲線 - Z移動 - 開始X
R_x1：（無視）
X_y1：（無視）
Y_y1：（無視）
【Z_y1】：補間曲線 - Z移動 - 開始Y
R_y1：（無視）
X_x2：（無視）
Y_x2：（無視）
【Z_x2】：補間曲線 - Z移動 - 終了X
R_x2：（無視）
X_y2：（無視）
Y_y2：（無視）
【Z_y2】：補間曲線 - Z移動 - 終了Y
R_y2：（無視）
1：（無視）
0：（無視）
【R_x1】：補間曲線 - 回転 - 開始X
X_y1：（無視）
Y_y1：（無視）
Z_y1：（無視）
【R_y1】：補間曲線 - 回転 - 開始Y
X_x2：（無視）
Y_x2：（無視）
Z_x2：（無視）
【R_x2】：補間曲線 - 回転 - 終了X
X_y2：（無視）
Y_y2：（無視）
Z_y2：（無視）
【R_y2】：補間曲線 - 回転 - 終了Y
01：（無視）
00：（無視）
00：（無視）


■ 元モーションの通りにならない場合　---------------------------------

このツールは、モデルの比率で一律変換しています。
そのため、「膝をつく」「正座をする」といったようなモーションは、元のモーションの通りにはならない場合があります。
その場合、お手数ですが手動修正をお願い致します。すみません。
しゃがんだ足のモーションは、センターZを多少前後させると直る可能性が高いです。
それ以外の場合は、多分足ボーン等（回転角度系）を修正する必要があると思います。


■ エラーが起きた場合　---------------------------------

　①　ファイルパスが正しくない場合

　　【エラーメッセージ】

　　　■■■■■■■■■■■■■■■■■
　　　■　**ERROR**　
　　　■　調整対象VMDファイルが見つかりませんでした。
　　　■■■■■■■■■■■■■■■■■

　　【原因】
　　　　ログに、上記のようなメッセージが出力された場合、
　　　　指定パスにファイルが存在していません。
　　　　（「調整対象VMDファイル」の部分は、エラーになった対象のファイル種別が表示されます）

　　【対応策】
　　　　ファイルの場所を確認して、正しいファイルパスを指定してください。

　---------------------

　②　ファイル種別が正しくない場合

　　【エラーメッセージ】

　　　■■■■■■■■■■■■■■■■■
　　　■　**ERROR**　
　　　■　調整対象VMDファイルが正常なファイルとして見つかりませんでした。
　　　■■■■■■■■■■■■■■■■■

　　【原因】
　　　　ログに、上記のようなメッセージが出力された場合、
　　　　フォルダ等、指定パスのファイルがファイルとして読み込めない可能性があります。
　　　　（「調整対象VMDファイル」の部分は、エラーになった対象のファイル種別が表示されます）

　　【対応策】
　　　　ファイルの場所を確認して、正しいファイルパスを指定してください。

　---------------------

　③　入力ファイルの解析に失敗した場合

　　【エラーメッセージ】

　　　■■■■■■■■■■■■■■■■■
　　　■　**ERROR**　
　　　■　VMDデータの解析に失敗しました。
　　　■■■■■■■■■■■■■■■■■

　　【原因】
　　　　ログに、上記のようなメッセージが出力された場合、
　　　　VMDもしくはPMXファイルの解析に失敗しています。

　　【対応策】
　　　　出力されたエラーメッセージを添えて、作者までご連絡ください。確認致します。

　---------------------

　④　出力先が長すぎるパスの場合

　　【エラーメッセージ】

　　　■■■■■■■■■■■■■■■■■
　　　■　**ERROR**　
　　　■　生成予定のファイルパスがWindowsの制限を超えているため、処理を中断します。
　　　■■■■■■■■■■■■■■■■■

　　【原因】
　　　　ログに、上記のようなメッセージが出力された場合、
　　　　出力VMDファイルのパスが長すぎて、正常にファイルが作れません。

　　【対応策】
　　　　もっと短いファイルパスを指定してください。

　---------------------

　⑤　サイジングに一部失敗している場合

　　【メッセージ】

　　　■■■■■■■■■■■■■■■■■
　　　■　サイジングに失敗している箇所があります。　
　　　■　ログ: xxx
　　　■■■■■■■■■■■■■■■■■

　　【原因】
　　　　手首位置合わせで、位置合わせに失敗した場合など、異常ではないけれど、
　　　　全部正常に終わる事が出来なかった場合にメッセージ欄とログファイルにメッセージを出力しています。
　　　　なお、異常データはすべてクリアしてから出力しております。
　　　　手が短いモデルで、物理的に手首位置合わせができない場合などに、エラーが起きやすいです。

　　【対応策】
　　　　ログファイルを確認してください。


■ 使用条件 他　---------------------------------

　《必須事項》

　　・変換したVMDモーションの結果を公開・配布する場合は、クレジットの明記のご協力をお願い致します。
　　・ニコニコ動画の場合、コンテンツツリーへ配布動画(sm35191377)を登録してください。
　　　※コンテンツツリーに親登録していただける場合、クレジット記載は任意です。


　《任意事項》

　　生成したモーションに関して、元々のモーションの規約の範囲内で、以下の行為は自由に行って下さい

　　・モーションの調整・改変
　　・ニコニコ動画、Youtube、Twitter等へのモーション使用動画投稿
　　　・進捗等で生成したモーションそのままを投稿することも問題ありません。
　　　・ただし、元々のモーションの規約で投稿先が制限されている場合、このツールで生成したモーションもそれに準じます。


　《禁止事項》

　　生成したモーションに関して、以下の行為はご遠慮願います

　　・元々のモーションの規約範囲外の行為
　　・モーションの完全自作発言
　　・各権利者様のご迷惑になるような行為
　　・営利目的の利用
　　・他者の誹謗中傷目的の利用（二次元・三次元不問）
　　・過度な暴力・猥褻・恋愛・猟奇的・政治的・宗教的表現を含む（R-15相当）作品への利用
　　・その他、公序良俗に反する作品への利用


　《免責事項》

　　・自己責任でご利用ください
　　・ツール使用によって生じたいかなる問題に関して、作者は一切の責任を負いかねます


■ ソースコード・ライブラリ　----------------------------------

このツールは、pythonで作成しており、以下ライブラリを使用・同梱しています。

・PyQt5
・wxPython
・pyinstaller

ソースコードは、Githubで公開しています。

https://github.com/miu200521358/vmd_sizing


■ クレジット　----------------------------------

　ツール名：　VMDサイジング
　作者：　miu200521358

　http://www.nicovideo.jp/user/2776342

　Twitter: @miu200521358
　Mail: garnet200521358@gmail.com


■ 履歴　----------------------------------------

ver3.00　（2019/07/26）
　　・UIをタブ形式に変更
　　・手首位置合わせ処理追加
　　・腕スタンス調整処理追加
　　・モーフ置換の置換処理変更（分割・合算を可能に）
　　・移動系ボーン縮尺の比率を変更
　　・CSVコンバーター機能追加
　　・Bugfix：足IK親を調整対象に追加、接触回避で手の位置推定処理修正

ver2.03　（2019/06/05）
　　・重心調整オフセット処理追加
　　・VMDファイルを指定した際にモデル名を表示するよう処理追加
　　・VMDファイルの出力時に変換先モデル名を出力するよう処理追加
　　・BugFix: 不足ボーン・モーフのチェックで不要な出力を除外

ver2.02　（2019/06/02）
　　・全ての親をサイジング対象に変更
　　・接触回避判定先を人差し指か手首か選べるようにプルダウン追加
　　・BugFix: ひじがたまに反転してしまう不具合を修正

ver2.01　（2019/05/29）
　　・モーフ置換機能追加

ver2.00　（2019/05/26）
　　・ローカル版一般配布開始

ver1.10　（2019/05/22）
　　・ローカル版テスト配布開始

ver1.00　（2019/4/29）
　　・colab版配布開始




