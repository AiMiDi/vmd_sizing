----------------------------------------------------------------
----------------------------------------------------------------

　「VMDサイジング　ローカル版」

　　ver5.01

　　　　　　　　　　　　　　　　　miu200521358

----------------------------------------------------------------
----------------------------------------------------------------


　この度は拙作をDLしていただき、ありがとうございます。
　お手数ですが以下をご確認のうえ、ご利用ください。

----------------------------------------------------------------


----------------------------------------------------------------
■　概要
----------------------------------------------------------------

　VMD(MMDモーションデータ)を、指定されたモデルに適切な頭身で再生成するツールです。


----------------------------------------------------------------
■　配布動画
----------------------------------------------------------------

■　VMDサイジングに複数人数モーション対応とスタンス追加補正を入れてみた【ver5.00】
https://www.nicovideo.jp/watch/sm37143852

■　ブロマガ
https://ch.nicovideo.jp/miu200521358/blomaga/ar1919098

■　コンテンツツリー用静画
https://seiga.nicovideo.jp/seiga/im9755721

----------------------------------------------------------------
■　同梱ファイル
----------------------------------------------------------------

　・VMDSizing_5.01_64bit.exe　　　…　ツール本体（ver5.00より64bit版のみです）
　・Readme.txt　　　　　　　　　　…　リドミ
　・VMDサイジングWiki　　　　　　 …　Wikiへのリンク
　・モーフ置換サンプル　　　　　　…　モーフ置換のサンプル集（詳細は中参照）
　・一括サイジングサンプル.csv　　…　一括サイジングのサンプルCSV

----------------------------------------------------------------
■　動作環境
----------------------------------------------------------------

　Windows8.1/10 64bit（確認はWindows10のみ）


----------------------------------------------------------------
■　起動
----------------------------------------------------------------

・基本的にはexeをそのまま起動していただければ大丈夫です。
　ハイスペック版は、内部で並列処理を行うので、通常版の1.3倍くらい速く処理が行われます。
　ただし、その分負荷も大きくなるので、PCの性能が大丈夫って方だけの方がよさげです。

・ログ出力版は、v4の頃のように、出力VMDファイルパスと同じところにログファイルを出力します。


----------------------------------------------------------------
■　サイジング機能
----------------------------------------------------------------

1) 基本機能

何もオプションを付けずにサイジングした場合に行われる処理です。

・縮尺補正
　…　元モデルを先モデルの縮尺に合わせて、移動系ボーンの位置を調整します。
　　　（全ての親、センター、グルーブ、足IK親、足ＩＫ、つま先ＩＫ）

　　　※ 複数人数モーション対応

　　　・「複数」タブでファイルセット（VMD・元モデル・先モデルのセット）を追加する事で、複数人数モーションを一括でサイジング可能です。
　　　　複数人数モーションを一括でサイジングした場合、全員の移動系縮尺比率が統一され、フォーメーションを崩しません。
　　　　また、位置合わせやカメラなども複数人数に対応しています。

・腕スタンス補正
　…　元モデルの腕の角度と先モデルの腕の角度を合わせます。
　　　ただし、元か先に腕IKが含まれている場合、「腕」タブのチェックスキップチェックボックスがOFFのままだと補正しません。
　　　（スキップチェックボックスがONだと強制補正可）

　　　※腕IKの扱い
　　　　・腕IKは、腕の向きを補助したり、服を補助するなど、モデルによって用途や構造が異なる為、機械的な判断が出来ません。
　　　　　そのため、「腕IK・うでIK・腕ＩＫ・うでＩＫ」を含むモデルはサイジングとしては対象外としています。
　　　　　モデルによっては、そのままサイジングしても問題ない場合も多いので、
　　　　　ひとまずチェックスキップしてみてダメだったら諦めるくらいでも良いと思います。


----------------
3) 元モーションの対象拡張子

・VMDファイル（モーション）
・VPDファイル（ポーズ）

また、ファイル名の部分をアスタリスク（*）に置き換えると、指定したフォルダ内の合致する全ファイルを一括で処理可能です。
・アスタリスク可なのは、「ファイル」タブの調整対象モーションVMD/VPD欄のみです。
・元モデル、先モデルは一体ずつしか指定できません。（全部同じ組み合わせでモーションだけ切り替える感じ）
・出力ファイルはVMDオンリーです。


----------------
4) スタンス追加補正

「ファイル」タブもしくは「複数」タブの「スタンス追加補正」チェックボックスをONにする事で行われる処理です。
「スタンス追加補正」チェックボックスの横の「＊」ボタンで、スタンス追加補正を取捨選択することが可能です。

・センターXZスタンス補正
　…　重心（センター位置）を元モデルに合わせて調整します。
　　　特にバレエのターン等、体幹が伸びてる状態での回転で効果が分かりやすいです。

・上半身補正
　…　頭の位置が元モデルと同じ位置になるよう、上半身と上半身2（あれば）を調整します。
　　　身体を反らしたり、屈んだりするモーションで効果が分かりやすいです。
　　　準標準までのボーンで構成された四つ足モデルなどは直立します。

・下半身補正
　…　足の中間の位置が元モデルと同じ位置になるよう、下半身を調整します。
　　　準標準までのボーンで構成された四つ足モデルなどは直立します。

・つま先ＩＫ補正
　…　つま先ＩＫの移動量を、足ＩＫの回転量に変換します。
　　　ねんどろ体型等、小さいモデルで効果が分かりやすいです。

・足ＩＫ補正
　…　足ボーンから見た足ＩＫの位置が元モデルと同じ位置になるよう、足ＩＫを調整します。
　　　ねんどろ体型等、小さいモデルで効果が分かりやすいです。

・つま先補正
　…　床からのつま先の距離を、元モデルと同じような位置に合わせます。
　　　足先EXも考慮済み（つま先ＩＫはちょっと苦手…）です。

・肩補正
　…　初期スタンスの肩の傾きの違いを考慮して、元モデルと同じくらいに動かすよう、肩と肩P（あれば）を調整します。
　　　肩が大きく動くモーションがダイナミックになります。

・センターY補正
　…　床からの腕の距離を、元モデルと同じような位置に合わせるよう、センターを調整します。
　　　v4までの床位置合わせの一部です。


----------------
5) 捩り分散補正

「ファイル」タブもしくは「複数」タブの「捩り分散あり」チェックボックスをONにする事で行われる処理です。

　・腕捩り　…　腕X、ひじXの捩り分を適用
　　手捩り　…　手首Xの捩り分を適用

・既に捩りが入っていても、それを考慮した上で分散処理を行います。
　ただし、捩りの性質上、変位点を見つけて、変位点キーフレ単位で処理してる、という処理を行ってるので、時間がかかります。


----------------
6) モーフ置換

元モーションの任意のモーフを、変換先モデルにある任意のモーフへと置換できます。
モーフの大きさも補正できます。
ファイルセット単位にモーフを指定できます。
A→B、B→Cを一気に指定された場合、BにはA+Bの補正値が、CにはBの補正値が入ります。


----------------
7) 腕系処理

接触回避と位置合わせの両方を処理可能（接触回避→位置合わせの順に処理）です。
腕スタンス補正と同じく、腕IKが入ってると処理が行われないので、処理させたい場合にはチェックスキップオプションをONにしてください。
接触回避で剛体選択処理を入れるため、タブ移動時、モデル読み込み処理が実行されます。

・接触回避
　…　指定されたボーン追従剛体と手が衝突してる場合、回避します。
　　　必要に応じて、PMXエディタで好きな箇所にボーン追従剛体を付けると簡単です。（PmxView＞編集＞選択ボーン＞基礎剛体の作成 - ボーン追従剛体）
　　　手の判定先は、人指先、手首、手首とひじの中間、ひじ、腕とひじの中間、の5ヶ所です。

・位置合わせ
　…　手首（もしくは指）の位置を、元モデルの位置に合わせます。
　　　複数人数モーションの場合、他人との位置合わせも行います。身長差は適当に補間しています。

　　　・指位置合わせ　…　手首だけでなく指位置でも位置合わせを行います。
　　　　　　　　　　　　　複数人数モーションの場合、時間がかかる割に綺麗にならないので警告が出ます。

　　　・床位置合わせ　…　手首同士だけでなく、床位置との位置合わせも行います。


----------------
8) カメラ処理

元モデルと同じ映り具合になるよう、カメラを同時に調整します。
複数人数モーションの場合、ピンで映ってる場合は身長差も補間します。
ただし、身長差が大きくて、かつ、多人数が映ってる場合、若干ズレます。その場合、視野角を少し調整すると合う場合が多いです。
ファイルセット単位で、カメラ元モデルを指定可能です。



----------------------------------------------------------------
■　一括サイジング機能
----------------------------------------------------------------

「一括」タブで、CSVを指定する事で、複数のサイジングを一括で行う事ができます。
具体的な値は「一括サイジングサンプル.csv」をご確認ください。
ヘッダの一行目は読み飛ばします。

01列目 … グループNo
          サイジングを実行したいグループ単位で連番をつけてください。
02列目 … 調整対象モーションVMD/VPD(フルパス)
          「ファイル」「複数」タブの「調整対象モーションVMD/VPD」ファイルパス。アスタリスクは使えません。
03列目 … モーション作成元モデルPMX
          「ファイル」「複数」タブの「モーション作成元モデルPMX」ファイルパス。
04列目 … モーション変換先モデルPMX
          「ファイル」「複数」タブの「モーション変換先モデルPMX」ファイルパス。
05列目 … 出力VMD
          「ファイル」「複数」タブの「出力VMD」。空欄の場合、調整対象モーションVMD/VPDと同じ階層に出力します。
06列目 … センターXZ補正
          「ファイル」「複数」タブの「スタンス追加補正＞センターXZ補正」チェックボックス。0:無効、1:有効のいずれか必須です。
07列目 … 上半身補正
          「ファイル」「複数」タブの「スタンス追加補正＞上半身補正」チェックボックス。0:無効、1:有効のいずれか必須です。
08列目 … 下半身補正
          「ファイル」「複数」タブの「スタンス追加補正＞下半身補正」チェックボックス。0:無効、1:有効のいずれか必須です。
09列目 … 足ＩＫ補正
          「ファイル」「複数」タブの「スタンス追加補正＞足ＩＫ補正」チェックボックス。0:無効、1:有効のいずれか必須です。
10列目 … つま先補正
          「ファイル」「複数」タブの「スタンス追加補正＞つま先補正」チェックボックス。0:無効、1:有効のいずれか必須です。
11列目 … つま先ＩＫ補正
          「ファイル」「複数」タブの「スタンス追加補正＞つま先ＩＫ補正」チェックボックス。0:無効、1:有効のいずれか必須です。
12列目 … 肩補正
          「ファイル」「複数」タブの「スタンス追加補正＞肩補正」チェックボックス。0:無効、1:有効のいずれか必須です。
13列目 … センターY補正
          「ファイル」「複数」タブの「スタンス追加補正＞センターY補正」チェックボックス。0:無効、1:有効のいずれか必須です。
14列目 … 捩り分散
          「ファイル」「複数」タブの「捩り分散」チェックボックス。0:無効、1:有効のいずれか必須です。
15列目 … モーフ置換
          「モーフ」タブの「モーフ置換」のセット。置換元モーフ:置換先モーフ:大きさ;を1つのセットとしてください。
16列目 … 接触回避
          「腕」タブの「接触回避」チェックボックス。0:無効、1:有効のいずれか必須です。
17列目 … 接触回避剛体
          「腕」タブの「接触回避」の対象剛体名リスト。剛体名;のように半角セミコロンで繋いでください。
18列目 … 位置合わせ
          「腕」タブの「位置合わせ」チェックボックス。0:無効、1:有効のいずれか必須です。
19列目 … 指位置合わせ
          「腕」タブの「指の位置で位置合わせを行う」チェックボックス。0:無効、1:有効のいずれか必須です。
20列目 … 床位置合わせ
          「腕」タブの「床との位置合わせも一緒に行う」チェックボックス。0:無効、1:有効のいずれか必須です。
21列目 … 手首の距離
          「腕」タブの「手首間の距離」スライダー。0以上の値が必須です。
22列目 … 指の距離
          「腕」タブの「指間の距離」スライダー。0以上の値が必須です。
23列目 … 床との距離
          「腕」タブの「手首と床との距離」スライダー。0以上の値が必須です。
24列目 … 腕チェックスキップ
          「腕」タブの「腕〜手首のサイジング可能チェックをスキップする」チェックボックス。0:無効、1:有効のいずれか必須です。
25列目 … カメラモーションVMD
          「カメラ」タブの「カメラモーションVMD」ファイルパス。グループ単位の1行目の値のみ参照します。
26列目 … 出力カメラVMD
          「カメラ」タブの「出力カメラVMD」。空欄の場合、カメラモーションVMDと同じ階層に出力します。
27列目 … 距離可動範囲
          「カメラ」タブの「距離可動範囲」スライダー。1以上の値が必須です。
28列目 … カメラ作成元モデルPMX
          「カメラ」タブの「カメラ作成元モデルPMX」ファイルパス。
29列目 … 全長Yオフセット
          「カメラ」タブの「全長Yオフセット」。


----------------------------------------------------------------
■　おまけ機能
----------------------------------------------------------------

1) CSV出力

・指定されたVMDモーションデータをCSV形式で出力します。
・ボーン・モーフ・カメラ別々のフォーマットとなっています。
・補間曲線も全て出力します。


----------------
2) VMD出力

・指定されたCSVデータ（CSV出力機能のフォーマット準拠）をVMDモーションデータとして出力します。
・補間曲線も全て出力します。

※スムージング・モーフブレンド・補間曲線ビューワーは、モーションサポーターに移植しました


----------------------------------------------------------------
■　詳しい使い方
----------------------------------------------------------------

　https://github.com/miu200521358/vmd_sizing/wiki/02.-%E4%BD%BF%E3%81%84%E6%96%B9

　使い方や解説の他、FAQや作成元モデルが見つからなかった場合の対応方法など、随時Wikiに記載しています。


----------------------------------------------------------------
■　問題が起きた場合
----------------------------------------------------------------

　https://github.com/miu200521358/vmd_sizing/wiki/03.-%E5%95%8F%E9%A1%8C%E3%81%8C%E8%B5%B7%E3%81%8D%E3%81%9F%E5%A0%B4%E5%90%88

　まず、上記ページを確認し、解決できるかご確認ください。
　それでも解決出来ない場合、不具合報告フォームよりご報告ください。（匿名可）

　https://docs.google.com/forms/d/e/1FAIpQLSe73r52CvtlTqI3oPCxgi8HiPBR-apC4kbFcfSHQd4-zuSEjQ/viewform


----------------------------------------------------------------
■　使用条件 他
----------------------------------------------------------------

　《必須事項》

　　・変換したVMDモーションの結果を公開・配布する場合は、クレジットの明記のご協力をお願い致します
　　・ニコニコ動画の場合、コンテンツツリーへツリー用静画(im9755721)を登録してください
　　　※コンテンツツリーに親登録していただける場合、クレジット記載は任意です


　《任意事項》

　　本ツールおよび生成したモーションに関して、元々のモーションの規約の範囲内で、以下の行為は自由に行って下さい

　　・モーションの調整・改変
　　・動画投稿サイト、SNS等へのモーション使用動画投稿
　　　・進捗等で生成したモーションそのままを投稿することも問題ありません
　　　・ただし、元々のモーションやモデルの規約で投稿先が制限されている場合、このツールで生成したモーションもそれに準じます

　《禁止事項》

　　本ツールおよび生成したモーションに関して、以下の行為はご遠慮願います

　　・元々のモーションやモデル等の規約範囲外の行為
　　・モーションの完全自作発言
　　・各権利者様のご迷惑になるような行為
　　・他者の誹謗中傷目的の利用（二次元・三次元不問）

　　※　ver4.02より以下の事項を禁止事項から除外いたします。
　　　『過度な暴力・猥褻・恋愛・猟奇的・政治的・宗教的表現を含む（R-15相当）作品への利用』

　　　・必ず元々のモーションやモデル等の規約範囲をご確認の上、ご利用ください。
　　　・また作品を公開される際には、検索避け等のご配慮をよろしくお願いいたします。

　　※　ver5.00より以下の事項を禁止事項から除外いたします。
　　　『営利目的の利用』

　《免責事項》

　　・元モーションから動きが変わる場合がありますので、自己責任でご利用ください
　　・ツール使用によって生じたいかなる問題に関して、作者は一切の責任を負いかねます


----------------------------------------------------------------
■　ソースコード・ライブラリ
----------------------------------------------------------------

このツールは、pythonで作成しており、以下ライブラリを使用・同梱しています。

・numpy (https://pypi.org/project/numpy/)
・bezier (https://pypi.org/project/bezier/)
・numpy-quaternion (https://pypi.org/project/numpy-quaternion/)
・wxPython (https://pypi.org/project/wxPython/)
・pyinstaller (https://pypi.org/project/PyInstaller/)

ソースコードは、Githubで公開しています。(MITライセンス)

https://github.com/miu200521358/vmd_sizing


----------------------------------------------------------------
■　クレジット
----------------------------------------------------------------

　ツール名：　VMDサイジング もしくは VMDSizing
　作者：　miu もしくは miu200521358

　http://www.nicovideo.jp/user/2776342
　Twitter: @miu200521358
　Mail: garnet200521358@gmail.com


----------------------------------------------------------------
■　履歴
----------------------------------------------------------------

ver5.00　（2020/07/05）
　　・数学ライブラリを PyQt5 から numpy に変更に伴い、作り直し
　　・複数人数モーションに対応
　　・スタンス追加補正追加
　　・捩り分散機能追加
　　・スムージング機能追加
　　・モーフブレンド機能追加

ver4.05　（2020/02/22）
　　・VMD出力時にバイナリ構成を調整して、VMDの読み込みが早くなるよう処理追加
　　・サイジング終了時に、音が出るよう機能追加（WindowsのINFO音）
　　・履歴機能付きファイルボタンの「開く」をクリックした際に、履歴の1件目のファイルが存在するフォルダを開くよう修正

ver4.04　（2019/12/10）
　　・Bugix: 床位置合わせオプションで「意図せぬエラー」が発生していたのを修正

ver4.03　（2019/12/04）
　　・フィンガータットモーション用に「指位置合わせ」オプション追加
　　・床位置合わせオプションの処理を調整
　　・床位置合わせオプションのセンター上下パラメーターを内部化
　　・Bugix: 床位置合わせオプションで「意図せぬエラー」が発生していたのを修正

ver4.02　（2019/11/17）
　　・床位置合わせオプションの手首や足と床の距離調整をパラメーター外部化
　　・親ボーンを辿る処理で、循環参照で無限ループエラーになった場合に警告メッセージを出力するよう処理追加
　　・Bugfix: モデル名に日本語・英語(cp932)以外の文字が入っている場合にエラーとなっていたのを修正

ver4.01　（2019/10/29）
　　・Bugfix: 「センター」がないモデルを変換先に指定すると落ちてしまっていたのを修正

ver4.00　（2019/10/25）
　　・カメラサイジング機能追加
　　・床位置合わせオプション機能追加
　　・つま先位置合わせ機能追加
　　・VMDコンバーター機能追加
　　・Bugfix: 重心補正の計算式を修正

ver3.00　（2019/07/26）
　　・UIをタブ形式に変更
　　・手首位置合わせ処理追加
　　・腕スタンス調整処理追加
　　・モーフ置換の置換処理変更（分割・合算を可能に）
　　・移動系ボーン縮尺の比率を変更
　　・CSVコンバーター機能追加
　　・Bugfix：足IK親を調整対象に追加、接触回避で手の位置推定処理修正

ver2.03　（2019/06/05）
　　・重心調整オフセット処理追加
　　・VMDファイルを指定した際にモデル名を表示するよう処理追加
　　・VMDファイルの出力時に変換先モデル名を出力するよう処理追加
　　・BugFix: 不足ボーン・モーフのチェックで不要な出力を除外

ver2.02　（2019/06/02）
　　・全ての親をサイジング対象に変更
　　・接触回避判定先を人差し指か手首か選べるようにプルダウン追加
　　・BugFix: ひじがたまに反転してしまう不具合を修正

ver2.01　（2019/05/29）
　　・モーフ置換機能追加

ver2.00　（2019/05/26）
　　・ローカル版一般配布開始

ver1.10　（2019/05/22）
　　・ローカル版テスト配布開始

ver1.00　（2019/4/29）
　　・colab版配布開始




